<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>INVEST ‚Äî Mode S√©curis√© (sans hash)</title>
<meta name="theme-color" content="#0b1220">
<style>
:root{--bg:#0b1220;--bg2:#0a1020;--text:#eef2ff;--muted:#9aa3bb;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.15)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.glass{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(10px);border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.2)}
.app{max-width:1100px;margin:40px auto 20px;padding:0 16px}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.logo{display:flex;gap:10px;align-items:center}
.logo-badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#2333a9,#4a8df0);display:flex;align-items:center;justify-content:center;font-weight:800}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;padding:10px}
.nav button{padding:10px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--text);cursor:pointer}
.nav button.active{background:linear-gradient(90deg,#1a2250,#0f1530);border-color:#2a3770}
.view{padding:12px}
.card{padding:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.muted{color:var(--muted)}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:10px 0}
.metric{background:var(--card);border:1px dashed var(--border);border-radius:12px;padding:10px}
.metric .label{font-size:12px;color:var(--muted)}
.metric .val{font-weight:800;font-size:20px}
</style>
<script>
// Couper tout service worker + caches
(function(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r=>{try{r.unregister()}catch(e){}}));
  }
  if (window.caches && caches.keys) {
    caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  }
})();
</script>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="logo">
      <div class="logo-badge">‚Ç¨</div>
      <div>
        <div style="font-weight:800">INVEST</div>
        <div class="muted" style="font-size:12px">Mode s√©curis√© (sans hash/URL)</div>
      </div>
    </div>
  </header>

  <div class="nav glass">
    <button class="tab active" data-view="dashboard">üìä Dashboard</button>
    <button class="tab" data-view="transactions">üí∏ Transactions</button>
    <button class="tab" data-view="budgets">üì¶ Budgets</button>
    <button class="tab" data-view="invest">üìà Invest</button>
    <button class="tab" data-view="goals">üéØ Objectifs</button>
    <button class="tab" data-view="analysis">üß† Analyses</button>
    <button class="tab" data-view="io">‚¨ÜÔ∏è‚¨áÔ∏è Import/Export</button>
    <button class="tab" data-view="settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <main id="view" class="view glass">Chargement‚Ä¶</main>
</div>

<script>
(function(){
'use strict';
const qs=s=>document.querySelector(s);
const qsa=s=>Array.from(document.querySelectorAll(s));
const cur=(n,c='EUR')=>{try{return new Intl.NumberFormat('fr-FR',{style:'currency',currency:c}).format(+n||0)}catch(e){return '‚Ç¨'+(+n||0)}};
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));

const KEY='invest_safe_v1';
let state={settings:{currency:'EUR'},transactions:[],budgets:[],goals:[]};
const save=()=>{try{localStorage.setItem(KEY,JSON.stringify(state))}catch(e){}};
const load=()=>{try{const j=localStorage.getItem(KEY);if(j)state=JSON.parse(j)}catch(e){}};

// Vues
function show(view){
  qsa('.tab').forEach(b=>b.classList.toggle('active', b.dataset.view===view));
  if(view==='dashboard'){
    qs('#view').innerHTML=`
    <section class="grid">
      <div class="card glass">
        <h3>Vue rapide</h3>
        <div class="grid">
          <div class="metric"><div class="label">Capital total</div><div class="val" id="k_total">‚Ç¨0</div></div>
          <div class="metric"><div class="label">Variation du mois</div><div class="val" id="k_var">‚Ç¨0</div></div>
          <div class="metric"><div class="label">Taux d‚Äô√©pargne</div><div class="val" id="k_save">0%</div></div>
        </div>
      </div>
    </section>`;
    // mini calc
    let inc=0,exp=0,inv=0,global=0;
    state.transactions.forEach(t=>{
      if(t.type==='income'){inc+=+t.amount;global+=+t.amount;}
      else if(t.type==='expense'){exp+=Math.abs(+t.amount);global-=Math.abs(+t.amount);}
      else if(t.type==='invest'){inv+=Math.abs(+t.amount);global-=Math.abs(+t.amount);}
    });
    qs('#k_total').textContent=cur(global,state.settings.currency);
    qs('#k_var').textContent=cur(inc-exp-inv,state.settings.currency);
    qs('#k_save').textContent=inc?(((inc-exp-inv)/Math.max(1,inc))*100).toFixed(1)+'%':'0%';
  }
  else if(view==='transactions'){
    qs('#view').innerHTML=`
    <section class="card glass">
      <h3>Transactions</h3>
      <form id="txf" class="form">
        <label>Type <select id="tt"><option value="income">Revenu</option><option value="expense">D√©pense</option><option value="invest">Investissement</option></select></label>
        <label>Date <input type="date" id="td"></label>
        <label>Compte <select id="ta"><option>Banque</option><option>PEA</option><option>CTO</option><option>Crypto</option></select></label>
        <label>Cat√©gorie <input id="tc" placeholder="Courses, Logement..."></label>
        <label>Description <input id="te" placeholder="Note"></label>
        <label>Montant (‚Ç¨) <input id="tm" type="number" step="0.01"></label>
        <button>Ajouter</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Compte</th><th>Cat√©gorie</th><th>Description</th><th>Montant</th></tr></thead><tbody id="tb"></tbody></table></div>
    </section>`;
    try{qs('#td').valueAsDate=new Date()}catch(e){}
    qs('#txf').addEventListener('submit',e=>{
      e.preventDefault();
      const t={date:qs('#td').value,type:qs('#tt').value,account:qs('#ta').value,category:qs('#tc').value||'(NC)',desc:qs('#te').value||'',amount:+(qs('#tm').value||0)};
      if(!t.date||!t.amount){alert('Date et montant requis');return}
      state.transactions.unshift(t); save(); renderTx();
    });
    renderTx();
  }
  else if(view==='budgets'){
    qs('#view').innerHTML=`
    <section class="card glass">
      <h3>Budgets</h3>
      <form id="bf" class="form">
        <label>Cat√©gorie <input id="bc"></label>
        <label>Montant (‚Ç¨) <input id="ba" type="number" step="0.01"></label>
        <button>Ajouter / MAJ</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr><th>Cat√©gorie</th><th>Budget</th></tr></thead><tbody id="bb"></tbody></table></div>
    </section>`;
    qs('#bf').addEventListener('submit',e=>{
      e.preventDefault();
      const c=(qs('#bc').value||'').trim(), a=+(qs('#ba').value||0);
      if(!c){alert('Cat√©gorie requise');return}
      const idx=state.budgets.findIndex(x=>x.category.toLowerCase()===c.toLowerCase());
      if(idx>=0) state.budgets[idx].amount=a; else state.budgets.push({category:c,amount:a});
      save(); renderBdg();
    });
    renderBdg();
  }
  else if(view==='invest'){
    qs('#view').innerHTML=`<section class="card glass"><h3>Invest</h3><p class="muted">Version simplifi√©e.</p></section>`;
  }
  else if(view==='goals'){
    qs('#view').innerHTML=`
    <section class="card glass">
      <h3>Objectifs</h3>
      <form id="gf" class="form">
        <label>Nom <input id="gn" placeholder="Ex: Capital 50 000 ‚Ç¨"></label>
        <label>Type <select id="gt"><option value="networth">Capital total</option><option value="saving">√âpargne mensuelle</option></select></label>
        <label>Cible (‚Ç¨) <input id="ga" type="number" step="0.01"></label>
        <button>Ajouter / MAJ</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr><th>Nom</th><th>Type</th><th>Cible</th></tr></thead><tbody id="gb"></tbody></table></div>
    </section>`;
    qs('#gf').addEventListener('submit',e=>{
      e.preventDefault();
      const n=(qs('#gn').value||'').trim(), t=qs('#gt').value, a=+(qs('#ga').value||0);
      if(!n||!a){alert('Nom et cible requis');return}
      const idx=state.goals.findIndex(g=>g.name.toLowerCase()===n.toLowerCase());
      const g={name:n,type:t,target:a};
      if(idx>=0) state.goals[idx]=g; else state.goals.push(g);
      save(); renderGoals();
    });
    renderGoals();
  }
  else if(view==='analysis'){
    qs('#view').innerHTML=`<section class="card glass"><h3>Analyses</h3><p class="muted">Ajoute des transactions pour voir des m√©triques sur le Dashboard.</p></section>`;
  }
  else if(view==='io'){
    qs('#view').innerHTML=`
    <section class="card glass">
      <h3>Import / Export</h3>
      <div class="form">
        <button id="exj">Exporter JSON</button>
        <button id="exc">Exporter CSV (transactions)</button>
        <label class="glass" style="padding:10px;border-radius:12px">Import JSON<input id="imj" type="file" accept=".json" style="display:none"></label>
        <label class="glass" style="padding:10px;border-radius:12px">Importer CSV g√©n√©rique<input id="imc" type="file" accept=".csv" style="display:none"></label>
      </div>
      <p class="muted">Donn√©es locales (navigateur). Pense √† sauvegarder.</p>
    </section>`;
    qs('#exj').onclick=()=>{const data=JSON.stringify(state,null,2);dl('budget.json',data,'application/json')};
    qs('#exc').onclick=()=>{const header='date,type,account,category,desc,amount\n';const rows=state.transactions.map(t=>[t.date,t.type,t.account,t.category,esc(t.desc),t.amount].join(','));dl('transactions.csv',header+rows.join('\n'),'text/csv')};
    qs('#imj').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{try{const d=JSON.parse(fr.result);if(!d.transactions)throw new Error('Fichier invalide');state=d;save();show('dashboard');alert('Import JSON OK')}catch(err){alert('Import rat√©: '+err.message)}};fr.readAsText(f)});
    qs('#imc').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{try{const rows=parseCSV(fr.result);importGeneric(rows);save();show('dashboard');alert('Import CSV OK')}catch(err){alert('Import CSV rat√©: '+err.message)}};fr.readAsText(f)});
  }
  else if(view==='settings'){
    qs('#view').innerHTML=`
    <section class="card glass">
      <h3>Param√®tres</h3>
      <div class="form">
        <label>Devise <select id="cu"><option value="EUR">EUR (‚Ç¨)</option><option value="USD">USD ($)</option></select></label>
        <button id="sav">Enregistrer</button>
        <button id="rst">R√©initialiser</button>
      </div>
    </section>`;
    const cu=qs('#cu'); cu.value=state.settings.currency;
    qs('#sav').onclick=()=>{state.settings.currency=cu.value; save(); alert('Param√®tres enregistr√©s');};
    qs('#rst').onclick=()=>{ if(confirm('Supprimer TOUTES les donn√©es ?')){ localStorage.removeItem(KEY); location.reload(); } };
  }
}

function renderTx(){const tb=qs('#tb'); if(!tb) return; tb.innerHTML=''; state.transactions.forEach(t=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.date}</td><td>${t.type}</td><td>${t.account}</td><td>${t.category}</td><td>${esc(t.desc)}</td><td>${cur(t.amount,state.settings.currency)}</td>`; tb.appendChild(tr)});}
function renderBdg(){const tb=qs('#bb'); if(!tb) return; tb.innerHTML=''; state.budgets.forEach(b=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${b.category}</td><td>${cur(b.amount,state.settings.currency)}</td>`; tb.appendChild(tr)});}
function renderGoals(){const tb=qs('#gb'); if(!tb) return; tb.innerHTML=''; state.goals.forEach(g=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(g.name)}</td><td>${g.type}</td><td>${cur(g.target,state.settings.currency)}</td>`; tb.appendChild(tr)});}

function dl(name,content,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:type}));a.download=name;a.click();}
function parseCSV(txt){const lines=txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');const rows=[];for(let i=0;i<lines.length;i++){const line=lines[i];if(!line.trim())continue;const cells=[],re=/("([^"]|"")*"|[^,]+)/g;let m;while((m=re.exec(line))!==null){let cell=m[0];if(cell.startsWith('"')&&cell.endsWith('"'))cell=cell.slice(1,-1).replace(/""/g,'"');cells.push(cell);}rows.push(cells);}return rows;}
function importGeneric(rows){const h=rows[0].map(s=>String(s).trim().toLowerCase());const id=k=>h.indexOf(k);if(id('date')<0||id('type')<0||id('amount')<0)throw new Error('En-t√™tes requis: date,type,amount');for(let i=1;i<rows.length;i++){const r=rows[i];if(!r||!r.length)continue;const tx={date:r[id('date')],type:r[id('type')],account:r[id('account')]||'Banque',category:r[id('category')]||'(NC)',desc:r[id('desc')]||'',amount:+String(r[id('amount')]||'0').replace(',','.')};if(!tx.date)continue;state.transactions.unshift(tx);}}

load();
qsa('.tab').forEach(b=>b.addEventListener('click',()=>show(b.dataset.view)));
show('dashboard');
})();
</script>
</body>
</html>
