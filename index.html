<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>INVEST ‚Äî Finances (Single File)</title>
<meta name="theme-color" content="#0b1220" />
<style>
:root{--bg:#0b1220;--bg2:#0a1020;--text:#eef2ff;--muted:#9aa3bb;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.15);--accent:#6ea8fe;--danger:#ef6b6b}
@media (prefers-color-scheme: light){body.theme-auto{--bg:#f5f7ff;--bg2:#ecf2ff;--text:#0c1327;--muted:#60729b;--card:rgba(0,0,0,.04);--border:rgba(0,0,0,.12)}}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}
.glass{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(10px);border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.2)}
.app{max-width:1100px;margin:40px auto 20px;padding:0 16px}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.logo{display:flex;gap:10px;align-items:center}
.logo-badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#2333a9,#4a8df0);display:flex;align-items:center;justify-content:center;font-weight:800}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;padding:10px}
.nav a{padding:10px 12px;border:1px solid var(--border);border-radius:999px}
.nav a.active{background:linear-gradient(90deg,#1a2250,#0f1530);border-color:#2a3770}
.view{padding:12px}
.card{padding:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.muted{color:var(--muted)}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:10px 0}
.metric{background:var(--card);border:1px dashed var(--border);border-radius:12px;padding:10px}
.metric .label{font-size:12px;color:var(--muted)}
.metric .val{font-weight:800;font-size:20px}
button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
.btn-primary{background:linear-gradient(90deg,#4a8df0,#6ea8fe);border-color:#4a8df0;color:#04122a;font-weight:700}
.btn-danger{background:linear-gradient(90deg,#ff7777,#ef6b6b);border-color:#ef6b6b;color:#2a0000}
canvas{max-width:100%}
</style>
<script>
// D√©sactiver tout Service Worker + vider caches (√©vite vieilles versions)
(function(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r=>{try{r.unregister()}catch(e){}}));
  }
  if (window.caches && caches.keys) {
    caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  }
})();
</script>
</head>
<body class="theme-auto">
  <div class="app">
    <header class="topbar">
      <div class="logo">
        <div class="logo-badge">‚Ç¨</div>
        <div>
          <div style="font-weight:800">INVEST</div>
          <div class="muted" style="font-size:12px">Single-file (sans cache) ‚Äî v1</div>
        </div>
      </div>
      <select id="theme">
        <option value="auto" selected>Th√®me: Auto</option>
        <option value="dark">Sombre</option>
        <option value="light">Clair</option>
      </select>
    </header>

    <nav class="nav glass">
      <a href="#/dashboard" class="navlink active">üìä Dashboard</a>
      <a href="#/transactions" class="navlink">üí∏ Transactions</a>
      <a href="#/budgets" class="navlink">üì¶ Budgets</a>
      <a href="#/invest" class="navlink">üìà Invest</a>
      <a href="#/goals" class="navlink">üéØ Objectifs</a>
      <a href="#/analysis" class="navlink">üß† Analyses</a>
      <a href="#/io" class="navlink">‚¨ÜÔ∏è‚¨áÔ∏è Import/Export</a>
      <a href="#/settings" class="navlink">‚öôÔ∏è Param√®tres</a>
    </nav>

    <main id="view" class="view glass"></main>
  </div>

  <script>
  (function(){
  'use strict';
  function qs(s,r){return (r||document).querySelector(s)}
  function qsa(s,r){return Array.from((r||document).querySelectorAll(s))}
  function cur(n,c){try{return new Intl.NumberFormat('fr-FR',{style:'currency',currency:c||'EUR'}).format(+n||0)}catch(e){return '‚Ç¨'+(+n||0)}}
  function esc(s){return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#039;'}[m]))}

  const KEY='invest_single_v1';
  let state={settings:{theme:'auto',currency:'EUR'},transactions:[],budgets:[],holds:[],dca:[],goals:[]};
  function save(){try{localStorage.setItem(KEY,JSON.stringify(state))}catch(e){}}
  function load(){try{const j=localStorage.getItem(KEY);if(j){const o=JSON.parse(j);if(o&&typeof o==='object')state=o}}catch(e){}}
  function applyTheme(){const t=state.settings.theme||'auto';document.body.classList.remove('theme-auto','theme-dark','theme-light');document.body.classList.add('theme-'+t);const sel=qs('#theme');if(sel)sel.value=t;}
  if (document.getElementById('theme')) {
    document.getElementById('theme').addEventListener('change', e => { state.settings.theme=e.target.value; applyTheme(); });
  }

  // ROUTER
  const routes={};
  function route(path,render){routes[path]=render;}
  function nav(){const path=location.hash.replace('#','')||'#/dashboard';qsa('.navlink').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===path));(routes[path]||routes['#/dashboard'])();}
  window.addEventListener('hashchange', nav);

  // VIEWS
  function viewDashboard(){
    qs('#view').innerHTML = `
    <section class="grid">
      <div class="card glass">
        <h3>Vue rapide</h3>
        <div class="grid">
          <div class="metric"><div class="label">Capital total</div><div class="val" id="k_total">‚Ç¨0</div></div>
          <div class="metric"><div class="label">Variation du mois</div><div class="val" id="k_var">‚Ç¨0</div></div>
          <div class="metric"><div class="label">Taux d‚Äô√©pargne</div><div class="val" id="k_save">0%</div></div>
        </div>
        <p class="muted">Ajoute quelques transactions pour voir les chiffres bouger.</p>
      </div>
      <div class="card glass"><h3>D√©penses par cat√©gorie (mois)</h3><canvas id="bar" width="700" height="260"></canvas></div>
      <div class="card glass"><h3>Flux 12 mois</h3><canvas id="line" width="900" height="260"></canvas></div>
    </section>`;
    renderDashboard();
  }
  function renderDashboard(){
    const now=new Date(), y=now.getFullYear(), m=now.getMonth();
    const month=state.transactions.filter(t=>{const d=new Date(t.date);return d.getFullYear()===y&&d.getMonth()===m;});
    let inc=0,exp=0,inv=0;
    month.forEach(t=>{ if(t.type==='income') inc+=+t.amount; else if(t.type==='expense') exp+=Math.abs(+t.amount); else if(t.type==='invest') inv+=Math.abs(+t.amount); });
    let global=0;
    state.transactions.forEach(t=>{ if(t.type==='income') global+=+t.amount; else if(t.type==='expense'||t.type==='invest') global-=Math.abs(+t.amount); });
    const k_total=qs('#k_total'), k_var=qs('#k_var'), k_save=qs('#k_save');
    if(k_total) k_total.textContent = cur(global, state.settings.currency);
    if(k_var)   k_var.textContent   = cur(inc-exp-inv, state.settings.currency);
    if(k_save)  k_save.textContent  = inc? (((inc-exp-inv)/Math.max(1,inc))*100).toFixed(1)+'%':'0%';
    const bar=qs('#bar'); if(bar){ const x=bar.getContext('2d'); x.clearRect(0,0,bar.width,bar.height); x.fillStyle='#9aa3bb'; x.fillText('Graph barres (placeholder)',10,20); }
    const line=qs('#line'); if(line){ const x=line.getContext('2d'); x.clearRect(0,0,line.width,line.height); x.fillStyle='#9aa3bb'; x.fillText('Courbe 12 mois (placeholder)',10,20); }
  }

  function viewTx(){
    qs('#view').innerHTML = `
    <section class="card glass">
      <h3>Transactions</h3>
      <form id="txf" class="form">
        <label>Type
          <select id="tt"><option value="income">Revenu</option><option value="expense">D√©pense</option><option value="invest">Investissement</option></select>
        </label>
        <label>Date <input type="date" id="td"></label>
        <label>Compte
          <select id="ta"><option>Banque</option><option>PEA</option><option>CTO</option><option>Crypto</option></select>
        </label>
        <label>Cat√©gorie <input id="tc" placeholder="Courses, Logement..."></label>
        <label>Description <input id="te" placeholder="Note"></label>
        <label>Montant (‚Ç¨) <input id="tm" type="number" step="0.01"></label>
        <button class="btn-primary">Ajouter</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr>
        <th>Date</th><th>Type</th><th>Compte</th><th>Cat√©gorie</th><th>Description</th><th>Montant</th>
      </tr></thead><tbody id="tb"></tbody></table></div>
    </section>`;
    try{ qs('#td').valueAsDate = new Date(); }catch(e){}
    qs('#txf').addEventListener('submit', (e)=>{
      e.preventDefault();
      const t={date:qs('#td').value,type:qs('#tt').value,account:qs('#ta').value,category:qs('#tc').value||'(NC)',desc:qs('#te').value||'',amount:+(qs('#tm').value||0)};
      if(!t.date || !t.amount){ alert('Date et montant requis'); return; }
      state.transactions.unshift(t); save(); renderTx();
    });
    renderTx();
  }
  function renderTx(){
    const tb=qs('#tb'); if(!tb) return; tb.innerHTML='';
    state.transactions.forEach(t=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.account}</td><td>${t.category}</td><td>${esc(t.desc)}</td><td>${cur(t.amount,state.settings.currency)}</td>`;
      tb.appendChild(tr);
    });
    renderDashboard();
  }

  function viewBdg(){
    qs('#view').innerHTML = `
    <section class="card glass">
      <h3>Budgets</h3>
      <form id="bf" class="form">
        <label>Cat√©gorie <input id="bc"></label>
        <label>Montant (‚Ç¨) <input id="ba" type="number" step="0.01"></label>
        <button class="btn-primary">Ajouter / MAJ</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr><th>Cat√©gorie</th><th>Budget</th></tr></thead><tbody id="bb"></tbody></table></div>
    </section>`;
    qs('#bf').addEventListener('submit',(e)=>{
      e.preventDefault();
      const c=(qs('#bc').value||'').trim(); const a=+(qs('#ba').value||0);
      if(!c){ alert('Cat√©gorie requise'); return; }
      const idx = state.budgets.findIndex(x=>x.category.toLowerCase()===c.toLowerCase());
      if(idx>=0) state.budgets[idx].amount=a; else state.budgets.push({category:c,amount:a});
      save(); renderBdg();
    });
    renderBdg();
  }
  function renderBdg(){
    const tb=qs('#bb'); if(!tb) return; tb.innerHTML='';
    state.budgets.forEach(b=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${b.category}</td><td>${cur(b.amount,state.settings.currency)}</td>`;
      tb.appendChild(tr);
    });
  }

  function viewInv(){ qs('#view').innerHTML = `<section class="card glass"><h3>Invest</h3><p class="muted">Section simplifi√©e pour le moment.</p></section>`; }
  function viewGoals(){
    qs('#view').innerHTML = `
    <section class="card glass">
      <h3>Objectifs</h3>
      <form id="gf" class="form">
        <label>Nom <input id="gn" placeholder="Ex: Capital 50 000 ‚Ç¨"></label>
        <label>Type <select id="gt"><option value="networth">Capital total</option><option value="saving">√âpargne mensuelle</option></select></label>
        <label>Cible (‚Ç¨) <input id="ga" type="number" step="0.01"></label>
        <button class="btn-primary">Ajouter / MAJ</button>
      </form>
      <div class="table-wrap"><table class="table"><thead><tr><th>Nom</th><th>Type</th><th>Cible</th></tr></thead><tbody id="gb"></tbody></table></div>
    </section>`;
    qs('#gf').addEventListener('submit',(e)=>{
      e.preventDefault();
      const n=(qs('#gn').value||'').trim(), t=qs('#gt').value, a=+(qs('#ga').value||0);
      if(!n || !a){ alert('Nom et cible requis'); return; }
      const idx=state.goals.findIndex(g=>g.name.toLowerCase()===n.toLowerCase());
      const g={name:n,type:t,target:a};
      if(idx>=0) state.goals[idx]=g; else state.goals.push(g);
      save(); renderGoals();
    });
    renderGoals();
  }
  function renderGoals(){
    const tb=qs('#gb'); if(!tb) return; tb.innerHTML='';
    state.goals.forEach(g=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${esc(g.name)}</td><td>${g.type}</td><td>${cur(g.target,state.settings.currency)}</td>`;
      tb.appendChild(tr);
    });
  }

  function viewAnalysis(){ qs('#view').innerHTML = `<section class="card glass"><h3>Analyses</h3><p class="muted">Ajoute quelques transactions pour voir des m√©triques sur le Dashboard.</p></section>`; }
  function viewIO(){
    qs('#view').innerHTML = `
    <section class="card glass">
      <h3>Import / Export</h3>
      <div class="form">
        <button id="exj" class="btn-primary">Exporter JSON</button>
        <button id="exc">Exporter CSV (transactions)</button>
        <label class="glass" style="padding:10px;border-radius:12px">Import JSON<input id="imj" type="file" accept=".json" style="display:none"></label>
        <label class="glass" style="padding:10px;border-radius:12px">Importer CSV g√©n√©rique<input id="imc" type="file" accept=".csv" style="display:none"></label>
      </div>
      <p class="muted">Les donn√©es restent locales (navigateur). Pense √† sauvegarder.</p>
    </section>`;
    qs('#exj').onclick=function(){ const data=JSON.stringify(state,null,2); dl('budget.json',data,'application/json'); };
    qs('#exc').onclick=function(){ const header='date,type,account,category,desc,amount\n'; const rows=state.transactions.map(t=>[t.date,t.type,t.account,t.category,esc(t.desc),t.amount].join(',')); dl('transactions.csv',header+rows.join('\n'),'text/csv'); };
    qs('#imj').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const d=JSON.parse(fr.result); if(!d.transactions) throw new Error('Fichier invalide'); state=d; save(); nav(); alert('Import JSON OK'); }catch(err){ alert('Import rat√©: '+err.message); } }; fr.readAsText(f); });
    qs('#imc').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const rows=parseCSV(fr.result); importGeneric(rows); save(); nav(); alert('Import CSV OK'); }catch(err){ alert('Import CSV rat√©: '+err.message); } }; fr.readAsText(f); });
  }
  function dl(name,content,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type:type})); a.download=name; a.click(); }
  function parseCSV(txt){ const lines=txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n'); const rows=[]; for(let i=0;i<lines.length;i++){ const line=lines[i]; if(!line.trim()) continue; const cells=[], re=/(\"([^\"]|\"\")*\"|[^,]+)/g; let m; while((m=re.exec(line))!==null){ let cell=m[0]; if(cell.startsWith('\"')&&cell.endsWith('\"')) cell=cell.slice(1,-1).replace(/\"\"/g,'\"'); cells.push(cell); } rows.push(cells); } return rows; }
  function importGeneric(rows){ const h=rows[0].map(s=>String(s).trim().toLowerCase()); const id=k=>h.indexOf(k); if(id('date')<0||id('type')<0||id('amount')<0) throw new Error('En-t√™tes requis: date,type,amount'); for(let i=1;i<rows.length;i++){ const r=rows[i]; if(!r||!r.length) continue; const tx={date:r[id('date')],type:r[id('type')],account:r[id('account')]||'Banque',category:r[id('category')]||'(NC)',desc:r[id('desc')]||'',amount:+String(r[id('amount')]||'0').replace(',','.')}; if(!tx.date) continue; state.transactions.unshift(tx); } }

  // SETTINGS
  function viewSet(){
    qs('#view').innerHTML = `
    <section class="card glass">
      <h3>Param√®tres</h3>
      <div class="form">
        <label>Th√®me
          <select id="th"><option value="auto">Auto</option><option value="dark">Sombre</option><option value="light">Clair</option></select>
        </label>
        <label>Devise
          <select id="cu"><option value="EUR">EUR (‚Ç¨)</option><option value="USD">USD ($)</option></select>
        </label>
        <button id="sav" class="btn-primary">Enregistrer</button>
        <button id="rst" class="btn-danger">R√©initialiser</button>
      </div>
    </section>`;
    const th=qs('#th'), cu=qs('#cu');
    th.value=state.settings.theme; cu.value=state.settings.currency;
    qs('#sav').onclick=function(){ state.settings.theme=th.value; state.settings.currency=cu.value; save(); applyTheme(); alert('Param√®tres enregistr√©s'); };
    qs('#rst').onclick=function(){ if(confirm('Supprimer TOUTES les donn√©es ?')){ localStorage.removeItem(KEY); location.reload(); } };
  }

  // INIT
  function init(){
    load(); applyTheme();
    route('#/dashboard',viewDashboard);
    route('#/transactions',viewTx);
    route('#/budgets',viewBdg);
    route('#/invest',viewInv);
    route('#/goals',viewGoals);
    route('#/analysis',viewAnalysis);
    route('#/io',viewIO);
    route('#/settings',viewSet);
    if(!location.hash) location.hash = '#/dashboard';
    nav();
  }
  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded',init) : init();
  })();
  </script>
</body>
</html>
